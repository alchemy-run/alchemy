---
title: D1StateStore
description: Learn how to manage state with Cloudflare D1 databases.
---

import { Tabs, TabItem } from '@astrojs/starlight/components';

## Configuration Options

### Basic Configuration

```typescript
import { D1StateStore } from "alchemy/cloudflare";

const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope)
});
```

### Custom Database Name

Change the D1 database name to avoid conflicts or organize by environment:

```typescript
const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope, {
    databaseName: "my-app-state-prod"
  })
});
```

### Cloudflare API Configuration

Override default Cloudflare API settings:

```typescript
const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope, {
    databaseName: "my-app-state",
    // Cloudflare API options
    apiToken: process.env.CLOUDFLARE_API_TOKEN,
    accountId: process.env.CLOUDFLARE_ACCOUNT_ID,
    email: process.env.CLOUDFLARE_EMAIL,
    apiKey: process.env.CLOUDFLARE_API_KEY
  })
});
```

## Environment-Specific Configuration

### Development vs Production

Use different databases for different environments:

```typescript
const isDev = process.env.NODE_ENV === "development";

const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope, {
    databaseName: isDev 
      ? "my-app-state-dev"
      : "my-app-state-prod"
  })
});
```

### Per-Stage Databases

Use separate D1 databases for different deployment stages:

```typescript
const stage = process.env.STAGE ?? "dev";

const app = await alchemy("my-app", {
  stage,
  stateStore: (scope) => new D1StateStore(scope, {
    databaseName: `my-app-state-${stage}`
  })
});
```

### Multi-Account Configuration

Use different Cloudflare accounts for different environments:

```typescript
const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope, {
    databaseName: "my-app-state",
    accountId: process.env.NODE_ENV === "production" 
      ? process.env.CLOUDFLARE_PROD_ACCOUNT_ID
      : process.env.CLOUDFLARE_DEV_ACCOUNT_ID
  })
});
```

## Database Management

### Automatic Database Creation

D1StateStore automatically creates the database if it doesn't exist:

```typescript
// This will create "alchemy-state" database if it doesn't exist
const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope)
});
```

### Database Configuration

D1 databases are created with read replication disabled by default:

```typescript
// The database is created with these settings:
{
  readReplication: { mode: "disabled" }
}
```

### Automatic Migrations

Database schema migrations are applied automatically:

- **Resources table**: Stores resource state and metadata
- **Dependencies table**: Tracks resource dependencies  
- **Locks table**: Handles concurrent access control
- **Migrations table**: Tracks applied migrations

:::tip
Migrations are applied every time the state store initializes, ensuring your database schema is always up to date.
:::

## Authentication

### API Token (Recommended)

Use a Cloudflare API token with D1 permissions:

```sh
# .env
CLOUDFLARE_API_TOKEN=your-api-token-here
CLOUDFLARE_ACCOUNT_ID=your-account-id-here
```

### Global API Key (Legacy)

Use email and global API key:

```sh
# .env
CLOUDFLARE_EMAIL=your-email@example.com
CLOUDFLARE_API_KEY=your-global-api-key
CLOUDFLARE_ACCOUNT_ID=your-account-id-here
```

### OAuth via Wrangler

Authenticate using Wrangler CLI:

```sh
wrangler login
```

## Wrangler CLI Integration

### Query the Database

Inspect your state data using Wrangler:

```sh
# List all resources
wrangler d1 execute alchemy-state --command "SELECT * FROM resources"

# Check dependencies
wrangler d1 execute alchemy-state --command "SELECT * FROM dependencies"

# View specific resource
wrangler d1 execute alchemy-state --command "SELECT * FROM resources WHERE id = 'my-resource-id'"
```

### Database Management

Manage the database using Wrangler commands:

```sh
# List all D1 databases
wrangler d1 list

# Get database info
wrangler d1 info alchemy-state

# Execute custom queries
wrangler d1 execute alchemy-state --command "PRAGMA table_info(resources)"
```

### Backup and Restore

Export and import database data:

```sh
# Export database
wrangler d1 export alchemy-state --output=backup.sql

# Import from backup (requires existing database)
wrangler d1 execute alchemy-state --file=backup.sql
```

## Performance Considerations

### Global Distribution

D1 databases provide global read replicas:

- **Primary region**: Where writes are processed
- **Read replicas**: Distributed globally for low-latency reads
- **Eventual consistency**: Reads may lag behind writes by a few seconds

### Query Optimization

Optimize queries for D1's SQLite engine:

```typescript
// Use indexes for better performance
// The state store automatically creates necessary indexes
```

### Concurrent Access

D1StateStore handles concurrent access through:

- **Atomic operations**: Each state operation is atomic
- **Lock management**: Prevents concurrent modifications
- **Retry logic**: Handles temporary conflicts

## Troubleshooting

### Authentication Errors

If you see authentication errors:

```
Error: Authentication failed
```

Verify your Cloudflare credentials:

```sh
# Check API token permissions
curl -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
  -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN"

# Verify account access
wrangler whoami
```

### Database Creation Errors

If database creation fails:

```
Error: Failed to create D1 database
```

Check your account limits and permissions:

```sh
# List existing databases
wrangler d1 list

# Check account limits in dashboard
open https://dash.cloudflare.com/d1
```

### Migration Errors

If migrations fail to apply:

```
Error: Migration failed
```

The state store will retry automatically. For persistent issues:

1. Check database permissions
2. Verify network connectivity
3. Review Cloudflare status page

### Connection Timeouts

For connection timeout issues:

```typescript
const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope, {
    databaseName: "my-app-state",
    // Add timeout configuration if needed
    timeout: 30000 // 30 seconds
  })
});
```

## Advanced Configuration

### Custom Migration Path

Use custom migration files:

```typescript
// Note: D1StateStore uses the same migrations as other SQLite state stores
// Custom migrations are handled through the base SQLite state store
```

### Database Region Selection

D1 databases are created in Cloudflare's optimal region automatically. You cannot manually select the region, but Cloudflare automatically optimizes for:

- **Lowest latency** to your primary traffic
- **Compliance requirements** based on account settings
- **Geographic distribution** for global applications

### API Rate Limiting

Handle Cloudflare API rate limits:

```typescript
// The D1StateStore automatically handles rate limiting through:
// - Exponential backoff
// - Request queuing
// - Error retry logic
```

## Integration with Workers

### Binding D1 to Workers

The D1 database created by D1StateStore can be bound to Cloudflare Workers:

```typescript
// In your worker's wrangler.toml
[[d1_databases]]
binding = "STATE_DB"
database_name = "alchemy-state"
database_id = "your-database-id"
```

### Worker Code

Access the database from your worker:

```typescript
export default {
  async fetch(request: Request, env: Env) {
    // Query the same database used by your Alchemy app
    const result = await env.STATE_DB.prepare("SELECT * FROM resources").all();
    return new Response(JSON.stringify(result));
  }
};
```

## Migration from Other State Stores

### From FileSystemStateStore

Migrate from local file storage to D1:

```typescript
// Before
const app = await alchemy("my-app", {
  // Uses default FileSystemStateStore
});

// After
const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope)
});
```

### From SQLiteStateStore

Migrate from local SQLite to D1:

```typescript
// Before
import { SQLiteStateStore } from "alchemy/sqlite";
const app = await alchemy("my-app", {
  stateStore: (scope) => new SQLiteStateStore(scope)
});

// After
import { D1StateStore } from "alchemy/cloudflare";
const app = await alchemy("my-app", {
  stateStore: (scope) => new D1StateStore(scope)
});
```

:::note
Schema migration is automatic - D1StateStore uses the same database schema as other SQLite-based state stores.
:::

## Cost Considerations

D1 pricing includes:

- **Database storage**: $0.75/GB per month
- **Read operations**: 25M reads/month included, then $0.001/1K reads
- **Write operations**: 50K writes/month included, then $1.00/1M writes

For state storage, typical usage patterns result in:
- **Low storage costs**: State data is typically small
- **Moderate read costs**: Frequent state lookups during deployments
- **Low write costs**: State changes only during resource updates 