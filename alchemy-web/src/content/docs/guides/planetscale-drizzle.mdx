---
title: Planetscale With Drizzle Migrations
description: Deploy a planetscale database and apply migrations on deploy
sidebar:
  order: 17
---

import { Steps } from '@astrojs/starlight/components';

This guide explains how to create and migrate [Planetscale](https://planetscale.com/) databases.

<Steps>

1. **Create a Planetscale Account and get an api key**

    Add the planetscale organization id and api token in the environment variables

    ```env
    PLANETSCALE_ORG_ID=${organization_id}
    PLANETSCALE_API_TOKEN=${api_token}
    ```

2. **Create a Planetscale Database**

   Unlike many cloud resources Planetscale handles branching, so we make sure to `adopt: true` the database.
   We also populate `migrationFramework` and `migrationTableName` to be set up for drizzle migrations.

   
   ```ts
   const database = await Database("Database", {
     adopt: true,
     name: "sample-database",
     organizationId: process.env.PLANETSCALE_ORG_ID!,
     region: {
       slug: "us-east",
     },
     clusterSize: "PS_10",
     allowDataBranching: true,
     automaticMigrations: true,
     requireApprovalForDeploy: false,
     defaultBranch: "main",
     migrationFramework: "other",
     migrationTableName: "__drizzle_migrations",
   });
   ```
   
   :::tip
   Planetscale requires payment for database creation. If payments aren't set up on your planetscale account you can create a database through the planetscale web UI then adopt it in alchemy
   :::

3. **Create a Database Branch**

   Next we need to create a database branch, this allows each stage to have its own "database"

   ```ts
   const branch = await Branch("Branch", {
     adopt: true,
     name: `${app.name}-${app.stage}-branch`,
     organizationId: process.env.PLANETSCALE_ORG_ID!,
     databaseName: database.name,
     parentBranch: database.defaultBranch,
     isProduction: false,
     safeMigrations: !scope.local,
   });
   ```
4. **Create a Password**

   Planetscale branches each need to have their own Password. We can create a password like so:

   ```ts
   const password = await Password("Password", {
     name: `${app.name}-${app.stage}-password`,
     organizationId: process.env.PLANETSCALE_ORG_ID!,
     database: database,
     branch: branch,
     role: "admin",
   });

   ```

   :::tip
   We need the planetscale branch password to have admin permissions so we can perform drizzle migrations.
   You may want to create 2 passwords: A temporary `admin` password for migrations and a long lived `readwriter` password for actual application use
   :::

5. **Set up Drizzle**

   Install `drizzle-orm` and `@planetscale/database`

   <Tabs syncKey="pkgManager">
     <TabItem label="bun">
       ```sh
       bun add @planetscale/database drizzle-orm
       ```
     </TabItem>
     <TabItem label="npm">
       ```sh
       npm install @planetscale/database drizzle-orm
       ```
     </TabItem>
     <TabItem label="pnpm">
       ```sh
       pnpm add @planetscale/database drizzle-orm
       ```
     </TabItem>
     <TabItem label="yarn">
       ```sh
       yarn add @planetscale/database drizzle-orm
       ```
     </TabItem>
   </Tabs>

   Install `drizzle-kit` as a dev dependency

   <Tabs syncKey="pkgManager">
     <TabItem label="bun">
       ```sh
       bun add -D drizzle-kit
       ```
     </TabItem>
     <TabItem label="npm">
       ```sh
       npm install -D drizzle-kit
       ```
     </TabItem>
     <TabItem label="pnpm">
       ```sh
       pnpm add -D drizzle-kit
       ```
     </TabItem>
     <TabItem label="yarn">
       ```sh
       yarn add -D drizzle-kit
       ```
     </TabItem>
   </Tabs>

   Create a `drizzle.config.ts` file that will handle migration connections

   ```ts
   import { defineConfig } from "drizzle-kit";

   export default defineConfig({
     out: "./drizzle",
     schema: "./src/schema.ts",
     dialect: "mysql",
     dbCredentials: {
       url: `mysql://${process.env.DATABASE_USERNAME}:${process.env.DATABASE_PASSWORD}@${process.env.DATABASE_HOST}/${process.env.DATABASE_NAME}?ssl={"rejectUnauthorized":true}`,
     },
   }); 
   ```

   Create a drizzle schema file
   
	 ```ts
   import { mysqlTable, serial, varchar } from "drizzle-orm/mysql-core";

   export const sampleTable = mysqlTable("sample_table", {
      id: serial("id").primaryKey(),
      value: varchar("value", { length: 255 }).notNull(),
   });
   ```

  6. **Run migrations on Alchemy deploy**

	 Add shortcut commands to create and run migrations. Note that `drizzle-kit migrate` will return error code `9` if there are no migrations. That should be gracefully handled as to not cause alchemy to error.

   ```ts
   import { Exec } from "alchemy/os";
 
   await Exec("DrizzleGenerate", {
     command: "bun run db:generate",
     env: {
       DATABASE_NAME: database.name,
       DATABASE_HOST: password.host,
       DATABASE_USERNAME: password.username,
       DATABASE_PASSWORD: password.password,
     },
   });
 
   await Exec("DrizzleMigrate", {
     command:
       process.platform === "win32"
         ? //* gracefully handle no migrations (drizzle exits with error code 9)
           `cmd /C "bun run db:migrate || if %ERRORLEVEL%==9 exit 0 else exit %ERRORLEVEL%"`
         : `sh -c 'bun run db:migrate || ( [ $? -eq 9 ] && exit 0 ); exit $?'`,
     env: {
       DATABASE_NAME: database.name,
       DATABASE_HOST: password.host,
       DATABASE_USERNAME: password.username,
       DATABASE_PASSWORD: password.password,
     },
   });
	 ```

	7. **Optionally run Drizzle Studio in local mode**

	 It may be convenient to start drizzle studio when running in local mode

	 ```ts
	 if (scope.local) {
     Exec("DrizzleStudio", {
       command: "bun run db:studio",
       env: {
         DATABASE_NAME: database.name,
         DATABASE_HOST: password.host,
         DATABASE_USERNAME: password.username,
         DATABASE_PASSWORD: password.password,
       },
     });
   }
	 ```




</Steps>

:::tip
For users with a more complicated `alchemy.run.ts` file it may be helpful to wrap all database related resources in their own scope.

```ts
const database = alchemy.run("PlanetscaleDatabase", async (scope) => {
	//... alchemy database resources

  return {
    database,
    branch,
    password,
  };
});
```
:::