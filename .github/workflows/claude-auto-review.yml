name: Claude Auto Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-auto-review:
    # Only run on PRs that aren't from dependabot or other bots
    if: |
      github.actor != 'dependabot[bot]' && 
      !endsWith(github.actor, '[bot]')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper diff analysis

      # node is needed for vitest and other tools
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Alchemy Environment
        uses: ./.github/actions/setup-alchemy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2

      - name: Run Claude Auto Review
        uses: anthropics/claude-code-action@beta
        with:
          # Direct prompt for automatic review without requiring @claude mention
          direct_prompt: |
            Please review this pull request and provide comprehensive feedback. Focus on:
            
            1. Code quality and best practices
            2. Potential bugs or issues
            3. Performance considerations
            4. Security concerns
            5. Test coverage and quality
            6. Documentation and comments
            7. Adherence to the project's coding standards (see CLAUDE.md if available)
            
            For Alchemy-specific code:
            - Ensure proper use of alchemy.secret() instead of new Secret()
            - Check that dependencies are added as peer dependencies
            - Verify Resource naming conventions (interface and export names must match)
            - Confirm proper phase handling in Resource implementations
            - Validate test structure and cleanup patterns
            
            Provide constructive feedback with specific suggestions for improvement.
            If the changes look good, mention that as well.
            
            Be thorough but concise in your review.
          
          allowed_tools: "Bash(bun:*)"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "30"
          # Limit conversation turns to prevent excessive back-and-forth
          max_turns: "3"
          
        env:
          # Set all the same environment variables that tests use
          CI: true
          ALCHEMY_STATE_STORE: cloudflare
          AWS_REGION: us-west-2
          BRANCH_PREFIX: claude-review-pr-${{ github.event.pull_request.number }}
          # All secrets loaded from SSM parameter via setup-alchemy action
          ALCHEMY_PASSWORD: ${{ env.ALCHEMY_PASSWORD }}
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_KEY: ${{ env.CLOUDFLARE_API_KEY }}
          CLOUDFLARE_BUCKET_NAME: ${{ env.CLOUDFLARE_BUCKET_NAME }}
          CLOUDFLARE_EMAIL: ${{ env.CLOUDFLARE_EMAIL }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          R2_ACCESS_KEY_ID: ${{ env.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ env.R2_SECRET_ACCESS_KEY }}
          STRIPE_API_KEY: ${{ env.STRIPE_API_KEY }}
          NEON_API_KEY: ${{ env.NEON_API_KEY }}
          SECRET_PASSPHRASE: ${{ env.SECRET_PASSPHRASE }}
          UPSTASH_API_KEY: ${{ env.UPSTASH_API_KEY }}
          UPSTASH_EMAIL: sam@alchemy.run
          SENTRY_AUTH_TOKEN: ${{ env.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ env.SENTRY_ORG }}
          VERCEL_ACCESS_TOKEN: ${{ env.VERCEL_ACCESS_TOKEN }}